{% extends 'layouts/main.html' %}

{% load static ac_extras ac_common %}

{% block title %}Aidants Connect - Sélectionnez l'usager{% endblock %}

{% block extracss %}
  <link href="{% static 'css/id_provider.css' %}" rel="stylesheet" />
  <link href="{% static 'css/users_search.css' %}" rel="stylesheet" />
  <link href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet" />
{% endblock extracss %}

{% block content %}
<div class="hero">
  <div class="hero__container">
    <h1 id="welcome_aidant">Bienvenue sur votre Espace Aidants Connect, {{ aidant.first_name }}</h1>
  </div>
</div>
<section
  class="section section-grey mandat-select__section"
  data-controller="search"
>
  <div class="container">
    <form method="post">
      <h2>Sélectionnez l'usager que vous souhaitez FranceConnecter</h2>
      <p id="instructions">Seuls les usagers avec un mandat en cours sont affichés ici.</p>
      {% if usagers %}
      <fieldset>
        <div class="user-search row">
          <label id="filter-input-label" for="filter-input">
            Rechercher un usager ou une usagère
          </label>
          <input type="text" id="filter-input" />
          <input id="filter-input-id" name="chosen_usager" hidden />
        </div>

          {% csrf_token %}
          <input type="hidden" name="connection_id" value="{{ connection_id }}" />
          <button id="submit-button" class="button" type="submit">Séléctionner</button>
        </fieldset>

      {% else %}
        <div class="notification" role="alert">
          Vous n’avez pas d'usagers avec au moins un mandat en cours.<br>
          Pour créer un nouveau mandat, rendez-vous sur votre <a href="{% url 'espace_aidant_home' %}">Espace Aidant</a>.
        </div>
      {% endif %}
    </form>
  </div>
</section>
{% endblock content %}

{% block extrajs %}
  <script src="https://code.jquery.com/jquery-3.6.1.js"></script>
  <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>

 {{ data|json_script:"usagers_list" }}

  <script>
    $(function () {

      const users = JSON.parse(document.querySelector("#usagers_list").textContent);

      const autoWidget = $("#filter-input").autocomplete({
        source: users,
        minLength: 3,
        focus : function(event, ui) {
          $("#filter-input").val(ui.item.label);
          return false;
        },
        select: function(event, ui) {
          $("#filter-input").val(ui.item.label);
          $("#filter-input-id").val(ui.item.value);
          return false;
        },
      })
      .data( "ui-autocomplete" )._renderItem = function( ul, item ) {
        return $( "<li>" )
          .attr("data-value", item.value )
          .append('<div class=ui-menu-item-wrapper>' + item.label +'</div>')
          .appendTo( ul );
      };
    });
  </script>
{% endblock %}
