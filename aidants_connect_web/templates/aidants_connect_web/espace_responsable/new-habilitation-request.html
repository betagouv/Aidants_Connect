{% extends 'layouts/main.html' %}
{% load ac_extras ac_common %}

{% load static dsfr_tags %}

{% block title %}Aidants Connect - Ajouter un aidant à une organisation{% endblock %}

{% block extracss %}
  <link href="{% static 'css/new-habilitation-request.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
  <div class="fr-container">
    {% include "layouts/_js-unavailable-alert.html" %}
    {% dsfr_django_messages %}

    <h1>Habiliter de nouveaux aidants</h1>
    <p>
      Pour ajouter un aidant à votre organisation, vous devez formuler une nouvelle demande d’habilitation à l’aide du
      formulaire ci-dessous. Tous les champs sont obligatoires.
    </p>
    <form method="post" action="{% url 'espace_responsable_aidant_new' %}">
      {% csrf_token %}

      <section class="habilitation-requests fr-mb-8v">
        <h2>Renseignez les détails du ou des aidants à habiliter</h2>
        {{ form.habilitation_requests.non_form_errors }}
        <div class="fr-grid-row fr-grid-row--gutters">
          {{ form.habilitation_requests.management_form }}

          {% with form=form.habilitation_requests.left_form %}
            <section id="empty-form" class="fr-col-12 fr-col-md-6">
              {% for field in form %}
                {% if field.is_hidden %}{{ field.as_hidden }}{% else %}{% dsfr_form_field field %}{% endif %}
                {% if field.name == "email" %}
                  <p class="fr-info-text fr-mb-4v">L’email doit être nominatif</p>
                {% endif %}
              {% endfor %}

              <button
                id="partial-submit"
                class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-user-add-line"
                type="submit"
                formaction="{{ partial_validate_path }}"
              >
                {% if edit_form is not None %}Valider les modifications{% else %}Ajouter un autre aidant{% endif %}
              </button>
            </section>
          {% endwith %}

          {% if form.habilitation_requests.right_forms|length > 0 %}
            <section id="added-forms" class="fr-col-12 fr-col-md-6 fr-background-contrast--grey fr-p-6v">
              <h3>Aidants ajoutés à la demande</h3>
              <div class="fr-grid-row fr-grid-row--gutters">
                {% for form_idx, form in form.habilitation_requests.right_forms %}
                  {# Prevent messing with the absolute positionning of the design #}
                  {# See https://stackoverflow.com/questions/17115344/absolute-positioning-ignoring-padding-of-parent #}
                  <div class="fr-col-12 fr-col-md-6">
                    <details id="added-form-{{ forloop.counter0 }}">
                      {{ form.as_hidden }}
                      <summary class="fr-grid-row fr-grid-row--middle fr-grid-row--gap-2v fr-tile--shadow fr-py-2v fr-px-4v">
                        <img src="{% static "images/avatar.svg" %}" width="36" height="36" alt="" />
                        <span class="fr-grid-row--center spacer">
                        <p class="fr-m-0 fr-text--bold">
                          {{ form.first_name.value|stringformat:'s' }} {{ form.last_name.value|stringformat:'s' }}
                        </p>
                          {% if form.email %}
                            <p class="details-summary-header fr-m-0 fr-text--overflow-hidden">
                            {{ form.email.value|stringformat:'s' }}
                          </p>
                          {% endif %}
                      </span>
                        <span
                          type="button"
                          class="fr-btn fr-btn--tertiary fr-btn--sm fr-icon-arrow-up-s-line"
                          aria-hidden="true"
                        ></span>
                      </summary>
                      <div class="details-content fr-p-4v fr-tile--shadow">
                        <section class="user-informations">
                          {% with fields="email profession conseiller_numerique organisation" %}
                            {% for field in fields.split %}
                              {% with field=form|get_dict_key:field %}
                                <section class="fr-my-4v">
                                  {% if field == form.conseiller_numerique %}
                                    <p class="fr-text--sm fr-text-mention--grey">Conseiller numérique</p>
                                    {{ form.conseiller_numerique.value|strtobool|yesno:"Oui,Non" }}
                                  {% elif field == form.organisation %}
                                    <p class="fr-text--sm fr-text-mention--grey">Organisation</p>
                                    {{ form.cleaned_data.organisation.name|stringformat:'s' }}
                                  {% else %}
                                    <p class="fr-text--sm fr-text-mention--grey">{{ field.label }}</p>
                                    {{ field.value|stringformat:'s' }}
                                  {% endif %}
                                </section>
                              {% endwith %}
                            {% endfor %}
                          {% endwith %}
                        </section>
                        <ul class="fr-btns-group fr-btns-group--sm fr-btns-group--right fr-btns-group--inline">
                          <li>
                            <button
                              id="edit-button-{{ form_idx }}"
                              class="fr-btn fr-btn--tertiary fr-icon-edit-fill"
                              formaction="{{ edit_profile_path }}{{ form_idx }}"
                            >
                              Éditer
                            </button>
                          </li>
                        </ul>
                      </div>
                    </details>
                  </div>
                {% endfor %}
              </div>

            </section>
          {% endif %}
        </div>
      </section>

      <section class="course-type">
        <h2>Choisissez le type de formation</h2>

        {# Inline checkboxes not yet supported by django-dsfr #}
        <fieldset
          class="fr-fieldset{% if form.course_type.type.errors %} fr-fieldset--error{% endif %}"
          id="radio-inline"
          aria-labelledby="radio-inline-legend radio-inline-messages"
        >
          <legend class="fr-fieldset__legend--regular fr-fieldset__legend" id="radio-inline-legend">
            {{ form.course_type.type.label }}
          </legend>
          {% for widget in form.course_type.type %}
            <div class="fr-col-6">
              <div class="fr-radio-group">
                {{ widget }}
                {% if widget.data.value == form.course_type.Type.CLASSIC %}
                  <div class="additionnal-informations">
                    <p>
                      Les nouveaux aidants seront formés par un organisme de formation habilité. Cette formation est
                      payante et financée seulement dans les 2 cas suivants :
                    </p>
                    <ul>
                      <li>
                        Pour les conseillers numériques, si elle fait partie des modules thématiques choisis lors de la
                        formation initiale ou continue ;
                      </li>
                      <li>Pour les aidants des structures adhérentes à l’OPCO Uniformation.</li>
                    </ul>
                    <p>Pour tous les autres cas, la formation doit être financée par la structure.</p>
                  </div>
                {% elif widget.data.value == form.course_type.Type.P2P %}
                  <div class="additionnal-informations">
                    <p>
                      Les nouveaux aidants seront formés par l’un de leur collègue habilité et utilisateur d’Aidants
                      Connect.
                    </p>
                    <div class="fr-alert fr-alert--info">
                      <p>
                        La formation entre pairs permet aux nouveaux aidants d’être formés par l’un de leur collègue
                        habilité et utilisateur d’Aidants Connect. Pour être éligible à la formation entre pairs, au
                        moins un aidant de votre structure doit avoir créé au moins 5 mandats. Cet aidant pourra alors
                        être désigné comme formateur.
                      </p>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}

          {% if form.course_type.type.errors %}
            <div class="fr-messages-group" id="{{ form.course_type.type.auto_id }}-messages">
              {{ form.course_type.type.errors }}
            </div>
          {% endif %}
        </fieldset>
      </section>
      <button id="form-submit" class="fr-btn fr-btn--icon-left fr-icon-check-line" type="submit">
        Valider la demande d’habilitation
      </button>
    </form>
  </div>
{% endblock content %}
