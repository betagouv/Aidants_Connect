{% extends 'layouts/main-habilitation.html' %}
{% load static ac_common ac_extras %}

{% block title %}Aidants Connect - Mon organisation{% endblock %}

{% block extracss %}
  <link href="{% static 'css/espace-aidant.css' %}" rel="stylesheet">
  <link href="{% static 'dsfr/alert.min.css' %}" rel="stylesheet">
{% endblock extracss %}

{% block content %}
  <div class="fr-container">
    {% if messages %}
      {% for message in messages %}
        <div class="notification {% if message.tags %}{{ message.tags }}{% endif %}" role="alert">{{ message }}</div>
      {% endfor %}
    {% endif %}
    <h1>Mon organisation</h1>
    <h2>{{ organisation.name }}</h2>
    <p class="subtitle">
      Retrouvez dans cette section, des ressources Ã  votre disposition, susceptibles de vous aider dans vos
      dÃ©marches dâ€™accompagnement.
    </p>

    <div class="fr-grid-row fr-grid-row--gutters margin-bottom-2rem">
      <div class="fr-col-12">
        {% include "aidants_connect_web/espace_aidant/notifications.html" with user=referent %}
      </div>
    </div>

    <div class="fr-grid-row fr-grid-row--gutters margin-bottom-2rem">
      {% for notification in referent_notifications %}
        <div class="fr-col-12">
          <div
            class="fr-alert{% if notification.type == notification_type.WARNING %} fr-alert--warning{% elif notification.type == notification_type.INFORMATION %} fr-alert--info{% else %} fr-alert--info{% endif %}"
            data-controller="notification"
            data-notification-url-value="{% url 'notification_mark' notification_id=notification.pk %}"
          >
            <h3 class="fr-alert__title">{{ notification.type_label }}</h3>
            <p>{{ notification.body }}</p>
            {% if notification.must_ack %}
              <button
                class="fr-btn--close fr-btn"
                title="Masquer le message"
                data-action="notification#markRead"
              >
                Masquer le message
              </button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

    {% include "aidants_connect_web/espace_aidant/statistics.html" %}

    <h2 class="clearfix">
      Aidants
      <span class="float-right">
        {% if organisation_active_aidants|length > 1 %}{# Organisation has more aidants than just the rÃ©fÃ©rent #}
          <a
            href="{% url 'espace_responsable_organisation_responsables' organisation_id=organisation.id %}"
            class="button"
          >
            <span aria-hidden="true">âš™ï¸Â </span>DÃ©signer un ou une rÃ©fÃ©rente
          </a>
        {% endif %}
        <a href="{% url "espace_responsable_aidant_new" %}" class="button">
          <span aria-hidden="true">ğŸ‘©Â </span>Ajouter un aidant
        </a>
      </span>
    </h2>

    {% if organisation_active_referents %}
      <h3>RÃ©fÃ©rents actifs</h3>
      {% include "aidants_connect_web/espace_responsable/_organisation_aidants_list.html" with aidants=organisation_active_referents table_class="shadowed blue-green" %}
    {% endif %}

    {% if organisation_active_aidants %}
      <h3>Aidants actifs</h3>
      {% include "aidants_connect_web/espace_responsable/_organisation_aidants_list.html" with aidants=organisation_active_aidants table_class="shadowed" %}
    {% endif %}

    {% if organisation_habilitation_requests %}
      <h3>Demandes dâ€™habilitation en cours</h3>

      <table class="table habilitation-list">
        <thead>
        <tr>
          <th>Nom</th>
          <th>Email</th>
          <th>Profession</th>
          <th>Ã‰tat de la demande</th>
          <th><span class="sr-only">Actions sur la demande dâ€™habilitation</span></th>
        </tr>
        </thead>
        <tbody class="shadowed blue">
        {% for request in organisation_habilitation_requests %}
          <tr>
            <td>{{ request.aidant_full_name }}</td>
            <td>{% mailto recipient=request.email %}</td>
            <td>{{ request.profession }}</td>
            <td>
              <div class="tooltip request-status-{{ request.status|lower }}">
                {{ request.get_status_display }}
                <div class="tooltiptext request-status-{{ request.status|lower }}">
                  {% if request.status|lower == "habilitation_waitling_list" %}
                    Les prochaines sessions de formation sur votre territoire sont complÃ¨tes.
                    Nous contacterons cet aidant dÃ¨s que possible.
                  {% elif request.status|lower == "new" %}
                    Cet aidant vient dâ€™Ãªtre ajoutÃ© sur lâ€™espace du rÃ©fÃ©rent Aidants Connect
                  {% elif request.status|lower == "processing" %}
                    Lâ€™Ã©quipe Aidants Connect a validÃ© lâ€™ajout de cet aidant, il est en cours de formation.
                  {% elif request.status|lower == "refused" %}
                    La demande dâ€™ajout de cet aidant est refusÃ©e pour lâ€™une des raisons suivantes :
                    <ul>
                      <li>lâ€™aidant nâ€™est pas Ã©ligible au dispositif (ex: infirmier),</li>
                      <li>
                        lâ€™adresse email ne respecte pas les critÃ¨res dâ€™Ã©ligibilitÃ© (nominative et professionnelle),
                      </li>
                      <li>lâ€™aidant est dÃ©jÃ  identifiÃ© dans la base de donnÃ©es.</li>
                    </ul>
                  {% elif request.status|lower == "cancelled" %}
                    Ã€ la demande de lâ€™aidant, lâ€™habilitation est annulÃ©e
                  {% elif request.status|lower == "status_cancelled_by_responsable" %}
                    Ã€ votre demande, lâ€™habilitation est annulÃ©e
                  {% endif %}
                </div>
              </div>
            </td>
            <td>
              {% if request.status_cancellable_by_responsable %}
                <a
                  id="cancel-habilitation-request-{{ request.id }}"
                  href="{% url "espace_responsable_cancel_habilitation" request_id=request.id %}"
                  class="button"
                >
                  Annuler la demande
                </a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% endif %}

    {% if organisation_inactive_referents %}
      <h3>RÃ©fÃ©rents dÃ©sactivÃ©s</h3>
      {% include "aidants_connect_web/espace_responsable/_organisation_aidants_list.html" with aidants=organisation_inactive_referents table_class="shadowed grey" %}
    {% endif %}

    {% if organisation_inactive_aidants %}
      <h3>Aidants dÃ©sactivÃ©s</h3>
      {% include "aidants_connect_web/espace_responsable/_organisation_aidants_list.html" with aidants=organisation_inactive_aidants table_class="shadowed grey" %}
    {% endif %}
  </div>
{% endblock content %}

{% block extrajs %}
  {% stimulusjs %}
  <script defer type="module" src="{% static 'js/notifications.js' %}"></script>
{% endblock %}
