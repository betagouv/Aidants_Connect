{% extends 'layouts/main.html' %}

{% load static %}
{% load ac_extras %}

{% block title %}Aidants Connect - Mon organisation : {{ organisation.name }}{% endblock %}

{% block extracss %}
  <link href="{% static 'css/espace_aidant.css' %}" rel="stylesheet">
{% endblock extracss %}

{% block content %}
  <section class="section">
    <div class="container">
      {% if messages %}
        {% for message in messages %}
          <div class="notification {% if message.tags %}{{ message.tags }}{% endif %}" role="alert">{{ message }}</div>
        {% endfor %}
      {% endif %}
      <h1>Mon organisation : {{ organisation.name }}</h1>
      {% include "aidants_connect_web/espace_aidant/notifications.html" with user=responsable %}
      <div class="tiles">
        <div class="grid">
          <div class="tile background-color-grey">
            <h3>Adresse</h3>
            <p>
              {{ organisation.address }}
            </p>
          </div>
          <div class="tile background-color-grey">
            <h3>Aidants actifs</h3>
            <h5>{{ organisation.num_active_aidants }}</h5>
          </div>
          <div class="tile background-color-grey">
            <h3>Mandats cr√©√©s</h3>
            <h5>{{ organisation.num_mandats }}</h5>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="section section-grey">
    <div class="container">
      <h2>Aidants</h2>
      <p class="text-right">
        <a href="{% url "espace_responsable_aidant_new" organisation_id=organisation.id %}" class="button">
          <span aria-hidden="true">üë©</span>
          Ajouter un aidant
        </a>
      </p>
      {% if aidants %}
        <table class="table aidants-list">
          <thead>
          <tr>
            <th scope="col">Nom</th>
            <th scope="col">Email</th>
            <th scope="col">Carte Aidants Connect</th>
          </tr>
          </thead>
          <tbody>
          {% for aidant in aidants %}
            <tr {% if not aidant.is_active %}class="inactive"{% endif %}>
              <th scope="row">
                <a href="{% url "espace_responsable_aidant" organisation_id=organisation.id aidant_id=aidant.id %}">
                  {{ aidant.get_full_name }}
                  {% if not aidant.is_active %}
                    <br>(Compte d√©sactiv√©)
                  {% endif %}
                </a>
              </th>
              <td>{{ aidant.email }}</td>
              <td>
                {% with aidant.carte_totp.serial_number as sn %}
                  {% if sn %}
                    {{ sn }}
                    {% if not totp_devices_users|get_dict_key:aidant.id %}
                      <div class="notification warning">

                        <span aria-hidden="true">‚ö†Ô∏è </span>Le fonctionnement de cette carte n'a pas √©t√© v√©rifi√©.<br>
                        Vous devez
                        <a href="{% url "espace_responsable_validate_totp" organisation_id=organisation.id aidant_id=aidant.id %}">
                          valider la carte</a>
                        pour permettre √† {{ aidant.get_full_name }} de se connecter √† Aidants Connect.
                      </div>

                    {% endif %}
                  {% else %}
                    <a href="{% url "espace_responsable_associate_totp" organisation_id=organisation.id aidant_id=aidant.id %}"
                       class="button">Lier une carte</a>
                  {% endif %}
                {% endwith %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="notification" role="alert">L'organisation n'a pas encore d'aidants.</div>
      {% endif %}
    </div>
  </section>

  {% if habilitation_requests %}
    <section class="section">
      <div class="container">
        <h2>Requ√™tes d‚Äôhabilitation</h2>
        <table class="table aidants-list">
          <thead>
          <tr>
            <th scope="col">Nom</th>
            <th scope="col">E-mail</th>
            <th scope="col">√âtat de la demande</th>
          </tr>
          </thead>
          <tbody>
          {% for hab_request in habilitation_requests %}
            <tr>
              <th scope="row">{{ hab_request.first_name }} {{ hab_request.last_name }}</th>
              <td>{{ hab_request.email }}</td>
              <td>{{ hab_request.status }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  {% endif %}
{% endblock content %}
